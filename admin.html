<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - Bountiful Blessings</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      max-width: 700px;
      margin: 2rem auto;
      padding: 1rem;
      background: #fff8f0;
      color: #333;
    }
    h1 {
      color: #f9a45c;
      text-align: center;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: 600;
    }
    input[type="email"], input[type="password"], textarea {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 1em;
    }
    button {
      margin-top: 1rem;
      padding: 12px 24px;
      border: none;
      background-color: #f9a45c;
      color: white;
      font-weight: 700;
      border-radius: 30px;
      cursor: pointer;
      font-size: 1em;
    }
    button:hover {
      background-color: #e0884f;
    }
    #login-section, #admin-section {
      margin-top: 2rem;
    }
    #carousel-images {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    #carousel-images img {
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid transparent;
    }
    #carousel-images img.selected {
      border-color: #f9a45c;
    }
    .message {
      margin-top: 1rem;
      color: green;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>

<h1>Admin Panel</h1>

<section id="login-section">
  <label for="email">Email:</label>
  <input type="email" id="email" placeholder="Enter your email" />
  <label for="password">Password:</label>
  <input type="password" id="password" placeholder="Enter your password" />
  <button id="login-btn">Log In</button>
  <p id="login-message" class="error"></p>
</section>

<section id="admin-section" style="display:none;">
  <button id="logout-btn" style="float:right;">Log Out</button>
  <h2>Edit Food Pantry Schedule Text</h2>
  <textarea id="schedule-text" rows="5" placeholder="Edit the Food Pantry Schedule text here..."></textarea>
  <button id="save-schedule-btn">Save Schedule Text</button>
  <p id="schedule-message" class="message"></p>

  <h2>Manage Carousel Images</h2>
  <input type="file" id="image-upload" accept="image/*" multiple />
  <button id="upload-images-btn">Upload Images</button>
  <p id="upload-message" class="message"></p>

  <div id="carousel-images"></div>
</section>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, collection, addDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL, listAll, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA3mMfuz8T-VdV5slRAoO4d2mV2cjglEzU",
    authDomain: "bountifulblessingscc-a2787.firebaseapp.com",
    projectId: "bountifulblessingscc-a2787",
    storageBucket: "bountifulblessingscc-a2787.appspot.com",
    messagingSenderId: "154507345848",
    appId: "1:154507345848:web:c87225f2065ab5662d594d",
    measurementId: "G-DFKTEPT8GH"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const loginSection = document.getElementById('login-section');
  const adminSection = document.getElementById('admin-section');
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const loginMessage = document.getElementById('login-message');

  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');

  const scheduleTextArea = document.getElementById('schedule-text');
  const saveScheduleBtn = document.getElementById('save-schedule-btn');
  const scheduleMessage = document.getElementById('schedule-message');

  const imageUploadInput = document.getElementById('image-upload');
  const uploadImagesBtn = document.getElementById('upload-images-btn');
  const uploadMessage = document.getElementById('upload-message');
  const carouselImagesDiv = document.getElementById('carousel-images');

  // Auth state listener
  onAuthStateChanged(auth, user => {
    if (user) {
      loginSection.style.display = 'none';
      adminSection.style.display = 'block';
      loginMessage.textContent = '';
      loadScheduleText();
      loadCarouselImages();
    } else {
      loginSection.style.display = 'block';
      adminSection.style.display = 'none';
    }
  });

  // Login handler
  loginBtn.addEventListener('click', () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    loginMessage.textContent = '';
    signInWithEmailAndPassword(auth, email, password)
      .catch(error => {
        loginMessage.textContent = error.message;
      });
  });

  // Logout handler
  logoutBtn.addEventListener('click', () => {
    signOut(auth);
  });

  // Load schedule text from Firestore
  async function loadScheduleText() {
    const docRef = doc(db, 'content', 'scheduleText');
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      scheduleTextArea.value = docSnap.data().text;
    } else {
      scheduleTextArea.value = '';
    }
  }

  // Save schedule text
  saveScheduleBtn.addEventListener('click', async () => {
    const text = scheduleTextArea.value.trim();
    await setDoc(doc(db, 'content', 'scheduleText'), { text });
    scheduleMessage.textContent = 'Schedule text saved!';
    setTimeout(() => scheduleMessage.textContent = '', 3000);
  });

  // Load carousel images
  async function loadCarouselImages() {
    carouselImagesDiv.innerHTML = '';
    const listRef = ref(storage, 'carousel/');
    const res = await listAll(listRef);
    for (const itemRef of res.items) {
      const url = await getDownloadURL(itemRef);
      const img = document.createElement('img');
      img.src = url;
      img.title = itemRef.name;
      img.dataset.fullPath = itemRef.fullPath;
      img.addEventListener('click', () => {
        if (confirm('Delete this image?')) {
          deleteImage(itemRef.fullPath);
        }
      });
      carouselImagesDiv.appendChild(img);
    }
  }

  // Upload images handler
  uploadImagesBtn.addEventListener('click', async () => {
    const files = imageUploadInput.files;
    if (!files.length) {
      uploadMessage.textContent = 'Please select one or more images.';
      return;
    }
    uploadMessage.textContent = 'Uploading...';
    for (const file of files) {
      const storageRef = ref(storage, 'carousel/' + file.name);
      await uploadBytes(storageRef, file);
    }
    uploadMessage.textContent = 'Upload complete!';
    imageUploadInput.value = '';
    loadCarouselImages();
    setTimeout(() => uploadMessage.textContent = '', 3000);
  });

  // Delete image from storage
  async function deleteImage(path) {
    const imageRef = ref(storage, path);
    try {
      await deleteObject(imageRef);
      loadCarouselImages();
    } catch (error) {
      alert('Error deleting image: ' + error.message);
    }
  }
</script>

</body>
</html>
