<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - Bountiful Blessings</title>
  <style>
    :root {
      --peach: #ffb27f;
      --peach-deep: #e09760;
      --sage: #70a47b;
      --ink: #1f2937;
    }

    body {
      font-family: 'Montserrat', 'Arial', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #f5faff, #fff4ea);
      color: #333;
      padding: 24px 12px 48px;
    }

    .shell {
      max-width: 960px;
      margin: 0 auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
      padding: 28px 26px 34px;
      border: 1px solid #f2e7dd;
    }

    h1, h2, h3 {
      color: var(--ink);
      margin-top: 0;
    }

    h1 {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge {
      background: #fff1e5;
      color: var(--peach-deep);
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    input, textarea, button, label, select {
      font-family: inherit;
    }

    input, textarea {
      display: block;
      margin: 8px 0 16px;
      padding: 12px;
      width: 100%;
      font-size: 1em;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #fbfbfc;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .password-container {
      position: relative;
    }

    .password-container input {
      padding-right: 44px;
    }

    .toggle-password {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      user-select: none;
      font-size: 20px;
      color: #888;
      transition: color 0.3s;
    }

    .toggle-password:hover {
      color: var(--peach-deep);
    }

    button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background-color: var(--peach-deep);
      border: none;
      color: white;
      font-weight: 700;
      cursor: pointer;
      border-radius: 10px;
      transition: background-color 0.3s, transform 0.2s;
      box-shadow: 0 10px 20px rgba(224, 151, 96, 0.28);
    }

    button:hover {
      background-color: var(--peach);
      transform: translateY(-1px);
    }

    .ghost {
      background: #eef4ef;
      color: #2d6a4f;
      border: 1px solid #cfe4d5;
      box-shadow: none;
    }

    .hidden {
      display: none;
    }

    #message, #announcement-message, #images-status {
      color: #b91c1c;
      font-weight: 700;
      margin-top: 8px;
    }

    .success {
      color: #065f46;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    ul li {
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 480px;
      background: #f8fbff;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #e5ebf5;
    }

    ul li button {
      width: auto;
      padding: 6px 12px;
      background-color: #e04848;
      border: none;
      border-radius: 6px;
      font-size: 0.9em;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
      box-shadow: none;
    }

    ul li button:hover {
      background-color: #b33030;
    }

    .announcement-footer {
      font-style: italic;
      color: #6b7280;
      font-family: 'Georgia', serif;
      margin-top: 10px;
      font-size: 0.95em;
      letter-spacing: 0.06em;
    }

    .info-box {
      background: #fff7ec;
      border: 1px solid #fde0bd;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 16px;
    }

    .section-card {
      background: #fdfefe;
      border: 1px solid #ecf0f3;
      border-radius: 14px;
      padding: 18px 16px 10px;
      margin: 14px 0;
    }
  </style>
</head>
<body>
  <div class="shell">
    <h1>Admin Panel <span class="badge">Staff access</span></h1>
    <p class="info-box">Log in to post announcements and manage carousel images shown on the public site.</p>

    <div id="login-section">
      <label for="email">Email</label>
      <input id="email" type="email" placeholder="you@example.com" autocomplete="email" required />

      <label for="password">Password</label>
      <div class="password-container">
        <input id="password" type="password" placeholder="Enter your password" autocomplete="current-password" required />
        <span id="toggle-password" class="toggle-password" title="Show/Hide password">&#128065;</span>
      </div>

      <button id="login-btn">Login</button>
      <div id="message" aria-live="polite"></div>
    </div>

    <div id="admin-section" class="hidden">
      <div class="grid" style="align-items: start;">
        <div class="section-card">
          <h2>Update Announcement</h2>
          <div class="announcement-container">
            <textarea id="announcement-text" rows="4" placeholder="Write your announcement here..."></textarea>
            <div class="announcement-footer">â€” The staff of Bountiful Blessings of CC</div>
          </div>
          <button id="save-announcement-btn">Save announcement</button>
          <div id="announcement-message" aria-live="polite"></div>
        </div>

        <div class="section-card">
          <h2>Account</h2>
          <p>Stay signed in while working. Log out when finished.</p>
          <button class="ghost" id="logout-btn">Logout</button>
        </div>
      </div>

      <div class="section-card">
        <h2>Upload Carousel Images</h2>
        <p>Images are displayed on the homepage in the order uploaded.</p>
        <input type="file" id="image-upload" accept="image/*" multiple />
        <button id="upload-image-btn">Upload Images</button>
        <div id="images-status" aria-live="polite"></div>
        <h3>Uploaded Images</h3>
        <ul id="images-list"></ul>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabaseUrl = 'https://npqwopijwhutnvbbbmdd.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wcXdvcGlqd2h1dG52YmJibWRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MjI1OTAsImV4cCI6MjA2OTM5ODU5MH0.2aZzvYvnTvfInul_P7jnDbtVP6aaoCXGC8b29nHsOII'
    const supabase = createClient(supabaseUrl, supabaseKey)

    const loginSection = document.getElementById('login-section')
    const adminSection = document.getElementById('admin-section')
    const messageDiv = document.getElementById('message')

    const emailInput = document.getElementById('email')
    const passwordInput = document.getElementById('password')
    const loginBtn = document.getElementById('login-btn')
    const logoutBtn = document.getElementById('logout-btn')

    const announcementText = document.getElementById('announcement-text')
    const saveAnnouncementBtn = document.getElementById('save-announcement-btn')
    const announcementMessage = document.getElementById('announcement-message')

    const imageUploadInput = document.getElementById('image-upload')
    const uploadImageBtn = document.getElementById('upload-image-btn')
    const imagesList = document.getElementById('images-list')
    const imagesStatus = document.getElementById('images-status')

    const togglePassword = document.getElementById('toggle-password')
    togglePassword.addEventListener('click', () => {
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text'
        togglePassword.style.color = '#f9a45c'
      } else {
        passwordInput.type = 'password'
        togglePassword.style.color = '#888'
      }
    })

    function showTempMessage(element, msg, isError = true, time = 3000) {
      element.textContent = msg
      element.classList.toggle('success', !isError)
      setTimeout(() => {
        element.textContent = ''
        element.classList.remove('success')
      }, time)
    }

    async function checkSession() {
      const { data } = await supabase.auth.getSession()
      if (data?.session) {
        showAdmin()
        loadAnnouncement()
        loadImages()
      } else {
        showLogin()
      }
    }

    function showLogin() {
      loginSection.classList.remove('hidden')
      adminSection.classList.add('hidden')
      messageDiv.textContent = ''
      emailInput.value = ''
      passwordInput.value = ''
    }

    function showAdmin() {
      loginSection.classList.add('hidden')
      adminSection.classList.remove('hidden')
      messageDiv.textContent = ''
    }

    loginBtn.addEventListener('click', async () => {
      messageDiv.textContent = 'Logging in...'
      const email = emailInput.value.trim()
      const password = passwordInput.value.trim()
      if (!email || !password) {
        messageDiv.textContent = 'Please enter email and password'
        return
      }
      const { error } = await supabase.auth.signInWithPassword({ email, password })
      if (error) {
        messageDiv.textContent = 'Login failed: ' + error.message
      } else {
        messageDiv.textContent = ''
        showAdmin()
        loadAnnouncement()
        loadImages()
      }
    })

    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut()
      showLogin()
    })

    async function loadAnnouncement() {
      announcementMessage.textContent = ''
      try {
        const { data, error } = await supabase
          .from('announcements')
          .select('text')
          .order('created_at', { ascending: false })
          .limit(1)
          .single()

        if (error) throw error
        announcementText.value = data?.text || ''
        if (!data?.text) {
          showTempMessage(announcementMessage, 'No announcement saved yet.', false)
        }
      } catch (error) {
        announcementText.value = ''
        showTempMessage(announcementMessage, 'Error loading announcement: ' + error.message)
      }
    }

    saveAnnouncementBtn.addEventListener('click', async () => {
      const text = announcementText.value.trim()
      if (!text) {
        alert('Announcement cannot be empty')
        return
      }
      const { error } = await supabase.from('announcements').insert([{ text }])
      if (error) {
        alert('Failed to save announcement: ' + error.message)
      } else {
        showTempMessage(announcementMessage, 'Announcement saved', false)
        loadAnnouncement()
      }
    })

    async function loadImages() {
      imagesStatus.textContent = 'Loading images...'
      imagesList.innerHTML = ''
      try {
        const { data, error } = await supabase.storage.from('images').list('', { limit: 100 })
        if (error) throw error

        if (!data.length) {
          imagesList.innerHTML = '<li>No images uploaded yet.</li>'
          imagesStatus.textContent = ''
          return
        }

        data.forEach(file => {
          const li = document.createElement('li')
          li.textContent = file.name

          const deleteBtn = document.createElement('button')
          deleteBtn.textContent = 'Delete'
          deleteBtn.title = `Delete ${file.name}`
          deleteBtn.addEventListener('click', () => deleteImage(file.name))

          li.appendChild(deleteBtn)
          imagesList.appendChild(li)
        })
        imagesStatus.textContent = ''
      } catch (error) {
        showTempMessage(imagesStatus, 'Error loading images: ' + error.message)
      }
    }

    uploadImageBtn.addEventListener('click', async () => {
      const files = imageUploadInput.files
      if (!files.length) {
        alert('Please select at least one image file')
        return
      }

      let errors = []
      for (let i = 0; i < files.length; i++) {
        const file = files[i]
        const fileExt = file.name.split('.').pop()
        const fileName = `${Date.now()}-${i}.${fileExt}`
        const filePath = `images/${fileName}`

        const { error } = await supabase.storage.from('images').upload(filePath, file)
        if (error) errors.push(`${file.name}: ${error.message}`)
      }

      if (errors.length) {
        alert('Some uploads failed:\n' + errors.join('\n'))
      } else {
        showTempMessage(imagesStatus, 'Image(s) uploaded successfully', false)
      }
      imageUploadInput.value = ''
      loadImages()
    })

    async function deleteImage(filename) {
      if (!confirm(`Are you sure you want to delete "${filename}"?`)) return
      const { error } = await supabase.storage.from('images').remove([`images/${filename}`])
      if (error) {
        alert('Failed to delete image: ' + error.message)
        return
      }
      showTempMessage(imagesStatus, 'Image deleted', false)
      loadImages()
    }

    passwordInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        loginBtn.click()
      }
    })

    checkSession()
  </script>
</body>
</html>
